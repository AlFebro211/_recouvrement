<div class="dashboard">
    <h2 class="dashboard-title">üìä Tableau de Bord Financier</h2>

    <!-- FILTRES AVEC LABELS -->
    <div class="filter-box">
        {% csrf_token %}
        
        <div class="filter-group">
            <label for="anneeFilter">Ann√©e scolaire</label>
            <select id="anneeFilter">
                <option value="">-------</option>
                {% for a in annees %}
                <option value="{{a.id_annee}}">{{a}}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label for="classeFilter">Classe</label>
            <select id="classeFilter">
                <option value="">---------</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="trimestreFilter">Trimestre</label>
            <select id="trimestreFilter">
                <option value="">--------</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="variableFilter">Variable</label>
            <select id="variableFilter">
                <option value="">---------</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="eleveFilter">√âl√®ve</label>
            <select id="eleveFilter">
                <option value="">-------</option>
            </select>
        </div>
    </div>

    <!-- CARTES STATS -->
    <div class="dashboard-cards">
        <div class="card blue stat-card" data-type="transactions">
            <h4>Total Paiements</h4>
            <p id="totalPaiement">0</p>
        </div>
        <div class="card green stat-card" data-type="paye">
            <h4>Montant Pay√©</h4>
            <p id="montantPaye">0</p>
        </div>
        <div class="card purple stat-card" data-type="attendu">
            <h4>Total Attendu</h4>
            <p id="totalAttendu">0</p>
        </div>
        <div class="card orange stat-card" data-type="reste">
            <h4>Reste √† Payer</h4>
            <p id="restePaye">0</p>
        </div>
        <div class="card red stat-card" data-type="dette">
            <h4>√âl√®ves en Dette</h4>
            <p id="elevesDette">0</p>
        </div>
        <div class="card gray stat-card" data-type="rejet">
            <h4>Paiements Rejet√©s</h4>
            <p id="totalRejete">0</p>
        </div>
    </div>
</div>

<style>
:root {
    --primary-color: #2563eb;
    --accent-color: #dc2626;
    --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}

/* DASHBOARD */
.dashboard { 
    margin-left:300px; 
    padding:25px; 
    max-width:calc(100% - 300px); 
    font-family:sans-serif; 
}
.dashboard-title {
    font-size: 2rem;
    font-weight: 700;
    color: #06b6d4; /* Couleur principale pour visibilit√© */
    text-align: center;
    margin-top: 60px;
    margin-bottom: 30px;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.25); /* l√©g√®re ombre pour le contraste */
}
.filter-box { 
    display:flex; 
    gap:10px; 
    flex-wrap:wrap; 
    margin-bottom:25px; 
}
.filter-box select, .filter-box button { 
    padding:8px 12px;
    border-radius:8px;
    border:1px solid #ddd;
 }
.filter-box button { 
    background:var(--primary-color);
    color:white;
    cursor:pointer;
    font-weight:bold;
 }
 /* FILTER GROUP STYLES */
.filter-box {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 25px;
    align-items: flex-end; /* Aligne les selects avec le bas des labels */
}

.filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
    flex: 1 1 auto;
}

.filter-group label {
    font-size: 12px;
    font-weight: 600;
    color: #06b6d4;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-group select {
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    background-color: white;
    font-size: 14px;
    transition: all 0.2s;
    cursor: pointer;
    width: 100%;
}

.filter-group select:hover {
    border-color: #2563eb;
}

.filter-group select:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

/* Responsive pour petits √©crans */
@media (max-width: 768px) {
    .filter-group {
        min-width: 100%;
    }
}

/* Style option par d√©faut */
.filter-group select option:first-child {
    color: #9ca3af;
    font-style: italic;
}

/* Am√©lioration des cartes */
.dashboard-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.card {
    padding: 20px;
    border-radius: 12px;
    color: white;
    box-shadow: var(--card-shadow);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
}

.card h4 {
    margin: 0;
    font-size: 14px;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.card p {
    margin: 10px 0 0;
    font-size: 24px;
    font-weight: bold;
}

/* Couleurs des cartes */
.blue { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
.green { background: linear-gradient(135deg, #16a34a, #15803d); }
.purple { background: linear-gradient(135deg, #7c3aed, #6d28d9); }
.red { background: linear-gradient(135deg, #dc2626, #b91c1c); }
.orange { background: linear-gradient(135deg, #f97316, #ea580c); }
.gray { background: linear-gradient(135deg, #6b7280, #4b5563); }


/* MODAL */
/* ==============================
        MODAL DESIGN PRO
=================================*/

.stats-modal{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.55);
    backdrop-filter:blur(6px);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:9999;
    padding:20px;
}

.stats-modal-content{
    background:#ffffff;
    width:900px;
    max-width:100%;
    max-height:85vh;
    border-radius:16px;
    overflow:hidden;
    box-shadow:0 25px 50px rgba(0,0,0,0.25);
    animation:modalPop .35s ease;
    display:flex;
    flex-direction:column;
}

/* HEADER MODERNE */
.stats-modal-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:16px 22px;
    background:linear-gradient(135deg,#2563eb,#1e40af);
    color:white;
}

.stats-modal-header h3{
    margin:0;
    font-size:18px;
    font-weight:600;
    letter-spacing:.3px;
}

#closeModal{
    font-size:22px;
    cursor:pointer;
    transition:.2s;
}

#closeModal:hover{
    transform:scale(1.2);
    opacity:.8;
}

/* BODY SCROLLABLE */
#modalBody{
    padding:20px;
    overflow:auto;
}

/* TABLE DESIGN PRO */
#modalBody table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
    border-radius:12px;
    overflow:hidden;
}

#modalBody th{
    background:#f1f5f9;
    text-align:left;
    padding:12px;
    font-weight:600;
    color:#334155;
    position:sticky;
    top:0;
}

#modalBody td{
    padding:12px;
    border-bottom:1px solid #e5e7eb;
    color:#111827;
}

/* Lignes altern√©es */
#modalBody tr:nth-child(even){
    background:#fafafa;
}

/* Hover */
#modalBody tr:hover{
    background:#eef2ff;
    transition:.15s;
}

/* Alignement montant */
#modalBody td:last-child{
    font-weight:600;
    color:#2563eb;
}

/* Animation */
@keyframes modalPop{
    from{
        transform:translateY(20px) scale(.95);
        opacity:0;
    }
    to{
        transform:translateY(0) scale(1);
        opacity:1;
    }
}

</style>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- XLSX pour Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- jsPDF pour PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


<script>
$(document).ready(function(){

    // ==========================
    // VARIABLES GLOBALES
    // ==========================
    let currentStatsType = '';

    // ==========================
    // FONCTION POUR FORMATER LES MONTANTS
    // ==========================
    function formatMontant(montant) {
        return new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(montant);
    }

    // ==========================
    // FONCTION POUR TITRE PROFESSIONNEL
    // ==========================
    function getProfessionalTitle(type) {
        const titles = {
            'transactions': 'RAPPORT DES TRANSACTIONS FINANCI√àRES',
            'paye': '√âTAT DES ENCAISSEMENTS',
            'attendu': 'PR√âVISIONS DE RECETTES',
            'reste': 'SITUATION DES IMPAY√âS',
            'dette': 'LISTE DES √âL√àVES EN SITUATION D√âBITRICE',
            'rejet': 'RELEV√â DES PAIEMENTS REJET√âS'
        };
        return titles[type] || 'RAPPORT FINANCIER';
    }

    // ==========================
    // FONCTION POUR SOUS-TITRE AVEC FILTRES
    // ==========================
    function getSubtitle() {
        let parts = [];
        
        const anneeText = $('#anneeFilter option:selected').text();
        if (anneeText && anneeText !== 'Ann√©e scolaire') {
            parts.push(`Ann√©e: ${anneeText}`);
        }
        
        const classeOpt = $('#classeFilter option:selected');
        const classeFullText = classeOpt.text();
        if (classeFullText && classeFullText !== 'Classe') {
            parts.push(`Filtres: ${classeFullText}`);
        }
        
        const trimestreText = $('#trimestreFilter option:selected').text();
        if (trimestreText && trimestreText !== 'Trimestre') {
            parts.push(`Trimestre: ${trimestreText}`);
        }
        
        const variableText = $('#variableFilter option:selected').text();
        if (variableText && variableText !== 'Variable') {
            parts.push(`Variable: ${variableText}`);
        }
        
        const eleveText = $('#eleveFilter option:selected').text();
        if (eleveText && eleveText !== '√âl√®ve') {
            parts.push(`√âl√®ve: ${eleveText}`);
        }
        
        return parts.length > 0 ? parts.join(' ‚Ä¢ ') : '';
    }

    // ==========================
    // RESET DASHBOARD
    // ==========================
    function resetDashboard(){
        $('#totalPaiement, #montantPaye, #totalAttendu, #restePaye, #elevesDette, #totalRejete').text('0');
    }

    // ==========================
    // LOAD CLASSES
    // ==========================
    function loadClasses(anneeId){
        $('#classeFilter').html('<option value="">-----</option>');
        $('#trimestreFilter').html('<option value="">----</option>');
        $('#variableFilter').html('<option value="">-----</option>');
        $('#eleveFilter').html('<option value="">-----</option>');

        if(!anneeId){
            resetDashboard();
            return;
        }

        fetch(`/get_classes_actives_with_paie/${anneeId}/`)
        .then(res => res.json())
        .then(data => {
            if(data.success){
                data.classes.forEach(c => {
                    $('#classeFilter').append(`
                        <option value="${c.id_classe_active}"
                            data-campus-id="${c.id_campus}"
                            data-cycle-id="${c.id_cycle}">
                            ${c.campus_nom} - ${c.cycle_nom} - ${c.classe_nom}${c.groupe ? ' ('+c.groupe+')' : ''}
                        </option>
                    `);
                });
            }
        });
    }

    // ==========================
    // LOAD DASHBOARD DATA
    // ==========================
    function loadDashboard(){
        const annee = $('#anneeFilter').val();
        const classe = $('#classeFilter').val() || '';
        const eleve = $('#eleveFilter').val() || '';
        const trimestre = $('#trimestreFilter').val() || '';
        const variable = $('#variableFilter').val() || '';

        if(!annee){
            resetDashboard();
            return;
        }

        fetch(`/dashboard-data/?annee=${annee}&classe=${classe}&eleve=${eleve}&trimestre=${trimestre}&variable=${variable}`)
        .then(res => res.json())
        .then(data => {
            if(!data.success){
                resetDashboard();
                return;
            }

            const stats = data.stats;
            $('#totalPaiement').text(formatMontant(stats.total_transactions || 0));
            $('#montantPaye').text(formatMontant(stats.total_paye || 0));
            $('#totalAttendu').text(formatMontant(stats.total_attendu || 0));
            $('#restePaye').text(formatMontant(stats.reste_a_payer || 0));
            $('#elevesDette').text(stats.eleves_en_dette || 0);
            $('#totalRejete').text(formatMontant(stats.total_rejete || 0));
        });
    }

    // ==========================
    // ANNEE CHANGE
    // ==========================
    $('#anneeFilter').on('change', function(){
        const anneeId = $(this).val();
        resetDashboard();
        loadClasses(anneeId);
        loadDashboard();
    });

    // ==========================
    // CLASSE CHANGE
    // ==========================
    $('#classeFilter').on('change', function(){
        const opt = $(this).find(':selected');
        const selectedCampusId = opt.data('campus-id');
        const selectedCycleId = opt.data('cycle-id');
        const classeId = $(this).val();
        const anneeId = $('#anneeFilter').val();

        $('#trimestreFilter').html('<option value="">--------</option>');
        $('#variableFilter').html('<option value="">---------</option>');
        $('#eleveFilter').html('<option value="">-------</option>');

        if(!classeId || !anneeId){
            loadDashboard();
            return;
        }

        // Charger les trimestres
        fetch(`/get_trimestres_by_classe_active/?id_classe_active=${classeId}&id_annee=${anneeId}&id_campus=${selectedCampusId}&id_cycle=${selectedCycleId}`)
        .then(res => res.json())
        .then(data => {
            if(data.success){
                data.trimestres.forEach(t => {
                    $('#trimestreFilter').append(`<option value="${t.id}">${t.nom}</option>`);
                });
            }
            loadDashboard();
        });

        // Charger les √©l√®ves
        fetch(`/get_pupils_registred_classe/?id_campus=${selectedCampusId}&id_cycle=${selectedCycleId}&id_classe_active=${classeId}&id_annee=${anneeId}`)
        .then(res => res.json())
        .then(data => {
            if(data.success){
                data.data.forEach(e => {
                    $('#eleveFilter').append(`<option value="${e.id_eleve}">${e.nom_complet}</option>`);
                });
            }
        });
    });

    // ==========================
    // TRIMESTRE CHANGE
    // ==========================
    $('#trimestreFilter').on('change', function(){
        const trimestreId = $(this).val();
        const anneeId = $('#anneeFilter').val();
        const classeOpt = $('#classeFilter').find(':selected');
        const selectedCampusId = classeOpt.data('campus-id');
        const selectedCycleId = classeOpt.data('cycle-id');
        const classeId = $('#classeFilter').val();

        $('#variableFilter').html('<option value="">---------</option>');

        if(!trimestreId || !anneeId || !classeId){
            loadDashboard();
            return;
        }

        fetch(`/get-variables-by-trimestre/?id_trimestre=${trimestreId}&id_classe=${classeId}&id_annee=${anneeId}&id_campus=${selectedCampusId}&id_cycle=${selectedCycleId}`)
        .then(res => res.json())
        .then(data => {
            if(data.success){
                data.variables.forEach(v => {
                    $('#variableFilter').append(`<option value="${v.id_variable}">${v.nom_variable}</option>`);
                });
            }
            loadDashboard();
        });
    });

    // ==========================
    // AUTRES FILTRES CHANGE
    // ==========================
    $('#variableFilter, #eleveFilter').on('change', loadDashboard);

    // ==========================
    // STAT CARD CLICK
    // ==========================
    $('.stat-card').on('click', function(){
    const type = $(this).data('type');
    currentStatsType = type;

    const annee = $('#anneeFilter').val();
    const classe = $('#classeFilter').val() || '';
    const eleve = $('#eleveFilter').val() || '';
    const trimestre = $('#trimestreFilter').val() || '';
    const variable = $('#variableFilter').val() || '';

    if(!annee) {
        alert('Veuillez s√©lectionner une ann√©e scolaire');
        return;
    }

    const professionalTitle = getProfessionalTitle(type);
    const subtitle = getSubtitle();

    $('#modalTitle').html(`
        <div style="display: flex; flex-direction: column;">
            <span style="font-size: 20px; font-weight: 700;">${professionalTitle}</span>
            ${subtitle ? `<span style="font-size: 13px; font-weight: 400; opacity: 0.9; margin-top: 4px;">${subtitle}</span>` : ''}
        </div>
    `);
    
    $('#modalBody').html('<div style="text-align: center; padding: 40px;"><div class="spinner"></div> Chargement en cours...</div>');
    $('#statsModal').css('display','flex');

    fetch(`/dashboard-details/?type=${type}&annee=${annee}&classe=${classe}&eleve=${eleve}&trimestre=${trimestre}&variable=${variable}`)
    .then(res => res.json())
    .then(data => {
        if(!data.success || !data.rows || !data.rows.length){
            $('#modalBody').html('<div style="text-align: center; padding: 40px; color: #666;">Aucune donn√©e disponible pour les filtres s√©lectionn√©s</div>');
            return;
        }

        const showEleve = type === 'dette' || type === 'paye' || type === 'transactions';
        let totalGeneral = 0;

        let html = `<table style="width:100%; border-collapse: collapse; font-size: 14px;">
            <thead>
                <tr>
                    <th style="text-align:left; padding: 14px; background: #1e3c72; color: white; border-radius: 8px 0 0 0;">Classe</th>
                    ${showEleve ? '<th style="text-align:left; padding: 14px; background: #1e3c72; color: white;">√âl√®ve</th>' : ''}
                    <th style="text-align:left; padding: 14px; background: #1e3c72; color: white;">Variable</th>
                    <th style="text-align:right; padding: 14px; background: #1e3c72; color: white; border-radius: 0 8px 0 0;">Montant</th>
                </tr>
            </thead>
            <tbody>`;

        data.rows.forEach((r, index) => {
            totalGeneral += parseFloat(r.total || 0);
            const bgColor = index % 2 === 0 ? '#ffffff' : '#f8fafc';
            
            html += `<tr style="background: ${bgColor};">
                <td style="padding: 12px 14px; border-bottom: 1px solid #e2e8f0;">${r.classe || '-'}</td>
                ${showEleve ? `<td style="padding: 12px 14px; border-bottom: 1px solid #e2e8f0;">${r.nom || '-'}</td>` : ''}
                <td style="padding: 12px 14px; border-bottom: 1px solid #e2e8f0;">${r.variable || '-'}</td>
                <td style="padding: 12px 14px; border-bottom: 1px solid #e2e8f0; text-align:right; font-weight: 500;">${formatMontant(r.total || 0)}</td>
            </tr>`;
        });

        html += `<tr style="background: #e2e8f0; font-weight: 700;">
            <td colspan="${showEleve ? 3 : 2}" style="padding: 14px; text-align:right; border-top: 2px solid #1e3c72;">TOTAL G√âN√âRAL</td>
            <td style="padding: 14px; text-align:right; border-top: 2px solid #1e3c72; color: #1e3c72;" data-total="${totalGeneral}">${formatMontant(totalGeneral)}</td>
        </tr>`;
        
        html += '</tbody></table>';
        
        $('#modalBody').html(html);
    })
    .catch(error => {
        console.error('Erreur:', error);
        $('#modalBody').html('<div style="text-align: center; padding: 40px; color: #dc2626;">Une erreur est survenue lors du chargement des donn√©es</div>');
    });
});

    // ==========================
    // FERMER MODAL
    // ==========================
    $('#closeModal').on('click', function(){
        $('#statsModal').fadeOut(200);
    });

    $('#statsModal').on('click', function(e){
        if(e.target === this){
            $(this).fadeOut(200);
        }
    });

    // ==========================
    // DOWNLOAD EXCEL
    // ==========================
    $('#downloadExcel').on('click', function(){
        const annee = $('#anneeFilter').val();
        const classe = $('#classeFilter').val() || '';
        const eleve = $('#eleveFilter').val() || '';
        const trimestre = $('#trimestreFilter').val() || '';
        const variable = $('#variableFilter').val() || '';

        if(!annee){
            alert("Veuillez s√©lectionner une ann√©e scolaire");
            return;
        }

        if (!currentStatsType) {
            alert("Veuillez d'abord s√©lectionner une statistique");
            return;
        }

        window.open(
            `/export-dashboard-excel/?type=${currentStatsType}&annee=${annee}&classe=${classe}&eleve=${eleve}&trimestre=${trimestre}&variable=${variable}`,
            "_blank"
        );
    });

    // ==========================
    // DOWNLOAD PDF
    // ==========================
    $('#downloadPDF').on('click', function(){
    const table = $('#modalBody table');
    if(!table || !table.length) {
        alert('Aucune donn√©e √† exporter');
        return;
    }

    const headers = [];
    table.find('thead th').each(function(){
        headers.push($(this).text().trim());
    });

    const rows = [];
    let totalGeneral = 0;
    
    // R√©cup√©rer toutes les lignes sauf la derni√®re (total)
    table.find('tbody tr').not(':last').each(function(){
        const row = [];
        $(this).find('td').each(function(){
            let text = $(this).text().trim();
            // Nettoyer le formatage (enlever les espaces)
            text = text.replace(/\s/g, '');
            row.push(text);
        });
        if(row.length) rows.push(row);
    });
    
    // R√©cup√©rer le total depuis l'attribut data-total
    const totalElement = table.find('tbody tr:last td:last');
    totalGeneral = totalElement.data('total') || 0;

    const selectedOption = $('#classeFilter option:selected');
    const modalTitle = $('#modalTitle span:first').text() || $('#modalTitle').text();
    
    // Afficher un indicateur de chargement
    const originalText = $(this).text();
    $(this).text('G√©n√©ration...').prop('disabled', true);

    fetch('/export-dashboard-pdf/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()
        },
        body: JSON.stringify({
            title: modalTitle,
            headers: headers,
            rows: rows,
            total: totalGeneral,  // Envoyer le total s√©par√©ment
            stats_type: currentStatsType,
            id_campus: selectedOption.data('campus-id'),
            id_cycle: selectedOption.data('cycle-id'),
            id_annee: $('#anneeFilter').val(),
            id_classe: $('#classeFilter').val(),
            id_eleve: $('#eleveFilter').val()
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erreur lors de la g√©n√©ration du PDF');
        }
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = modalTitle.replace(/\s+/g, '_') + '_' + new Date().toISOString().split('T')[0] + '.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors du t√©l√©chargement du PDF');
    })
    .finally(() => {
        $(this).text(originalText).prop('disabled', false);
    });
});
    // Initialisation au chargement
    loadDashboard();
});
</script>