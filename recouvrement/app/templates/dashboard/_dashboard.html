<div class="dashboard">
    <h2 class="dashboard-title">üìä Tableau de Bord Financier</h2>

    <!-- FILTRES -->
    <div class="filter-box">
        {% csrf_token %}
        <select id="anneeFilter">
            <option value="">Ann√©e scolaire</option>
            {% for a in annees %}
            <option value="{{a.id_annee}}">{{a}}</option>
            {% endfor %}
        </select>

        <select id="classeFilter"><option value="">Classe</option></select>
        <select id="trimestreFilter"><option value="">Trimestre</option></select>
        <select id="variableFilter"><option value="">Variable</option></select>
        <select id="eleveFilter"><option value="">√âl√®ve</option></select>
    </div>

    <!-- CARTES STATS -->
    <div class="dashboard-cards">
        <div class="card blue stat-card" data-type="transactions">
            <h4>Total Paiements</h4>
            <p id="totalPaiement">0</p>
        </div>
        <div class="card green stat-card" data-type="paye">
            <h4>Montant Pay√©</h4>
            <p id="montantPaye">0</p>
        </div>
        <div class="card purple stat-card" data-type="attendu">
            <h4>Total Attendu</h4>
            <p id="totalAttendu">0</p>
        </div>
        <div class="card orange stat-card" data-type="reste">
            <h4>Reste √† Payer</h4>
            <p id="restePaye">0</p>
        </div>
        <div class="card red stat-card" data-type="dette">
            <h4>√âl√®ves en Dette</h4>
            <p id="elevesDette">0</p>
        </div>
        <div class="card gray stat-card" data-type="rejet">
            <h4>Paiements Rejet√©s</h4>
            <p id="totalRejete">0</p>
        </div>
    </div>
</div>

<!-- MODAL DETAILS STATS -->
<div id="statsModal" class="stats-modal">
    <div class="stats-modal-content">
        <div class="stats-modal-header">
            <h3 id="modalTitle">D√©tails</h3>
            <span id="closeModal">&times;</span>
        </div>
        <div style="padding:10px 20px; display:flex; gap:10px; background:#f3f4f6">
    <button id="downloadExcel" style="background:#16a34a;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;">‚¨á Excel</button>
    <button id="downloadPDF" style="background:#2563eb;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;">‚¨á PDF</button>
</div>


        <div id="modalBody"></div>
    </div>
</div>

<style>
:root {
    --primary-color: #2563eb;
    --accent-color: #dc2626;
    --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}

/* DASHBOARD */
.dashboard { 
    margin-left:300px; 
    padding:25px; 
    max-width:calc(100% - 300px); 
    font-family:sans-serif; 
}
.dashboard-title {
    font-size: 2rem;
    font-weight: 700;
    color: #06b6d4; /* Couleur principale pour visibilit√© */
    text-align: center;
    margin-top: 60px;
    margin-bottom: 30px;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.25); /* l√©g√®re ombre pour le contraste */
}
.filter-box { 
    display:flex; 
    gap:10px; 
    flex-wrap:wrap; 
    margin-bottom:25px; 
}
.filter-box select, .filter-box button { 
    padding:8px 12px;
    border-radius:8px;
    border:1px solid #ddd;
 }
.filter-box button { 
    background:var(--primary-color);
    color:white;
    cursor:pointer;
    font-weight:bold;
 }

/* CARDS */
.dashboard-cards { 
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:20px;
    margin-bottom:30px;
 }
.card { 
    padding:20px;
    border-radius:12px;
    color:white;
    box-shadow:var(--card-shadow);
    cursor:pointer;
    transition: transform .2s;
}
.card:hover { 
    transform: translateY(-4px); 
}
.card h4 { 
    margin:0; 
    font-size:14px; 
    opacity:0.9; 
}
.card p { 
    margin:10px 0 0;
    font-size:24px;
    font-weight:bold;
 }
.blue { 
    background:linear-gradient(135deg,var(--primary-color),#1d4ed8); 
}
.green {
     background:linear-gradient(135deg,#16a34a,#15803d); 
}
.purple {
     background:linear-gradient(135deg,#7c3aed,#6d28d9); 
}
.red {
     background:linear-gradient(135deg,#dc2626,#b91c1c); 
}
.orange {
     background:linear-gradient(135deg,#f97316,#ea580c); 
}
.gray {
     background:linear-gradient(135deg,#6b7280,#4b5563); 
}

/* MODAL */
/* ==============================
        MODAL DESIGN PRO
=================================*/

.stats-modal{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.55);
    backdrop-filter:blur(6px);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:9999;
    padding:20px;
}

.stats-modal-content{
    background:#ffffff;
    width:900px;
    max-width:100%;
    max-height:85vh;
    border-radius:16px;
    overflow:hidden;
    box-shadow:0 25px 50px rgba(0,0,0,0.25);
    animation:modalPop .35s ease;
    display:flex;
    flex-direction:column;
}

/* HEADER MODERNE */
.stats-modal-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:16px 22px;
    background:linear-gradient(135deg,#2563eb,#1e40af);
    color:white;
}

.stats-modal-header h3{
    margin:0;
    font-size:18px;
    font-weight:600;
    letter-spacing:.3px;
}

#closeModal{
    font-size:22px;
    cursor:pointer;
    transition:.2s;
}

#closeModal:hover{
    transform:scale(1.2);
    opacity:.8;
}

/* BODY SCROLLABLE */
#modalBody{
    padding:20px;
    overflow:auto;
}

/* TABLE DESIGN PRO */
#modalBody table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
    border-radius:12px;
    overflow:hidden;
}

#modalBody th{
    background:#f1f5f9;
    text-align:left;
    padding:12px;
    font-weight:600;
    color:#334155;
    position:sticky;
    top:0;
}

#modalBody td{
    padding:12px;
    border-bottom:1px solid #e5e7eb;
    color:#111827;
}

/* Lignes altern√©es */
#modalBody tr:nth-child(even){
    background:#fafafa;
}

/* Hover */
#modalBody tr:hover{
    background:#eef2ff;
    transition:.15s;
}

/* Alignement montant */
#modalBody td:last-child{
    font-weight:600;
    color:#2563eb;
}

/* Animation */
@keyframes modalPop{
    from{
        transform:translateY(20px) scale(.95);
        opacity:0;
    }
    to{
        transform:translateY(0) scale(1);
        opacity:1;
    }
}

</style>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- XLSX pour Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- jsPDF pour PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


<script>
$(document).ready(function(){

    // ==========================
    // RESET DASHBOARD
    // ==========================
    function resetDashboard(){
        $('#totalPaiement,#montantPaye,#totalAttendu,#restePaye,#elevesDette,#totalRejete').text('0');
    }

    // ==========================
    // LOAD CLASSES
    // ==========================
    function loadClasses(anneeId){

        $('#classeFilter').html('<option value="">Classe</option>');
        $('#trimestreFilter').html('<option value="">Trimestre</option>');
        $('#variableFilter').html('<option value="">Variable</option>');
        $('#eleveFilter').html('<option value="">√âl√®ve</option>');

        if(!anneeId){
            resetDashboard();
            return;
        }

        fetch(`/get_classes_actives/${anneeId}/`)
        .then(res=>res.json())
        .then(data=>{

            if(data.success){

                data.classes.forEach(c=>{

                    $('#classeFilter').append(`
                        <option value="${c.id_classe_active}"
                            data-campus-id="${c.id_campus}"
                            data-cycle-id="${c.id_cycle}">
                            ${c.campus_nom} - ${c.cycle_nom} - ${c.classe_nom}
                        </option>
                    `);

                });

            }

        });

    }

    // ==========================
    // ANNEE CHANGE
    // ==========================
    $('#anneeFilter').on('change', function(){

        const anneeId = $(this).val();

        resetDashboard();
        loadClasses(anneeId);
        loadDashboard();

    });

    // ==========================
    // CLASSE CHANGE
    // ==========================
    $('#classeFilter').on('change', function(){

        const opt = $(this).find(':selected');

        // üî• IMPORTANT : on r√©cup√®re les ID (pas les noms)
        const selectedCampusId = opt.data('campus-id');
        const selectedCycleId = opt.data('cycle-id');

        const classeId = $(this).val();
        const anneeId = $('#anneeFilter').val();

        $('#trimestreFilter').html('<option value="">Trimestre</option>');
        $('#variableFilter').html('<option value="">Variable</option>');
        $('#eleveFilter').html('<option value="">√âl√®ve</option>');

        if(!classeId){
            loadDashboard();
            return;
        }

        // ======================
        // FETCH TRIMESTRES
        // ======================
        fetch(`/get_trimestres_by_classe_active/?id_classe_active=${classeId}&id_annee=${anneeId}&id_campus=${selectedCampusId}&id_cycle=${selectedCycleId}`)
        .then(res=>res.json())
        .then(data=>{

            if(data.success){

                data.trimestres.forEach(t=>{
                    $('#trimestreFilter').append(`<option value="${t.id}">${t.nom}</option>`);
                });

            }

            loadDashboard();

        });

        // ======================
        // FETCH ELEVES
        // ======================
        fetch(`/get_pupils_registred_classe/?id_campus=${selectedCampusId}&id_cycle=${selectedCycleId}&id_classe_active=${classeId}&id_annee=${anneeId}`)
        .then(res=>res.json())
        .then(data=>{

            if(data.success){

                data.data.forEach(e=>{
                    $('#eleveFilter').append(`<option value="${e.id_eleve}">${e.nom_complet}</option>`);
                });

            }

        });

    });

    // ==========================
    // TRIMESTRE CHANGE
    // ==========================
    $('#trimestreFilter').on('change', function(){

        const trimestreId = $(this).val();
        const anneeId = $('#anneeFilter').val();

        const classeOpt = $('#classeFilter').find(':selected');

        const selectedCampusId = classeOpt.data('campus-id');
        const selectedCycleId = classeOpt.data('cycle-id');
        const classeId = $('#classeFilter').val();

        $('#variableFilter').html('<option value="">Variable</option>');

        if(!trimestreId){
            loadDashboard();
            return;
        }

        // üî• FETCH VARIABLES RESTAUR√â
        fetch(`/get-variables-by-trimestre/?id_trimestre=${trimestreId}&id_classe=${classeId}&id_annee=${anneeId}&id_campus=${selectedCampusId}&id_cycle=${selectedCycleId}`)
        .then(res=>res.json())
        .then(data=>{

            if(data.success){

                data.variables.forEach(v=>{
                    $('#variableFilter').append(`<option value="${v.id_variable}">${v.nom_variable}</option>`);
                });

            }

            loadDashboard();

        });

    });

    // ==========================
    // AUTRES FILTRES
    // ==========================
    $('#variableFilter,#eleveFilter').on('change', loadDashboard);

    // ==========================
    // LOAD DASHBOARD DATA
    // ==========================
    function loadDashboard(){

        const annee = $('#anneeFilter').val();
        const classe = $('#classeFilter').val() || '';
        const eleve = $('#eleveFilter').val() || '';
        const trimestre = $('#trimestreFilter').val() || '';
        const variable = $('#variableFilter').val() || '';

        if(!annee){
            resetDashboard();
            return;
        }

        fetch(`/dashboard-data/?annee=${annee}&classe=${classe}&eleve=${eleve}&trimestre=${trimestre}&variable=${variable}`)
        .then(res=>res.json())
        .then(data=>{

            if(!data.success){
                resetDashboard();
                return;
            }

            const stats = data.stats;

            $('#totalPaiement').text(stats.total_transactions || 0);
            $('#montantPaye').text(stats.total_paye || 0);
            $('#totalAttendu').text(stats.total_attendu || 0);
            $('#restePaye').text(stats.reste_a_payer || 0);
            $('#elevesDette').text(stats.eleves_en_dette || 0);
            $('#totalRejete').text(stats.total_rejete || 0);

        });

    }
let currentStatsType = ''; // On garde le type actif pour nom du fichier et total

$('.stat-card').on('click', function(){

    const type = $(this).data('type');
    currentStatsType = type; // ‚úÖ on garde le type actif

    const annee = $('#anneeFilter').val();
    const classe = $('#classeFilter').val() || '';
    const eleve = $('#eleveFilter').val() || '';
    const trimestre = $('#trimestreFilter').val() || '';
    const variable = $('#variableFilter').val() || '';

    if(!annee) return;

    $('#modalTitle').text('Chargement...');
    $('#modalBody').html('Chargement...');
    $('#statsModal').css('display','flex');

    fetch(`/dashboard-details/?type=${type}&annee=${annee}&classe=${classe}&eleve=${eleve}&trimestre=${trimestre}&variable=${variable}`)
    .then(res=>res.json())
    .then(data=>{

        if(!data.success || !data.rows.length){
            $('#modalBody').html('Aucune donn√©e');
            return;
        }

        $('#modalTitle').text(data.title);

        const showEleve = type === 'dette' || type === 'paye';

        let totalGeneral = 0;

        let html = `<table style="width:100%;border-collapse:collapse">
            <tr>
                <th style="text-align:left;border-bottom:1px solid #ddd">Classe</th>
                ${showEleve ? '<th style="text-align:left;border-bottom:1px solid #ddd">√âl√®ve</th>' : ''}
                <th style="text-align:left;border-bottom:1px solid #ddd">Variable</th>
                <th style="text-align:right;border-bottom:1px solid #ddd">Total</th>
            </tr>`;

        data.rows.forEach(r => {
            totalGeneral += parseFloat(r.total || 0);
            html += `<tr>
                <td>${r.classe}</td>
                ${showEleve ? `<td>${r.nom || '-'}</td>` : ''}
                <td>${r.variable || '-'}</td>
                <td style="text-align:right">${r.total}</td>
            </tr>`;
        });

        // Ligne total
        html += `<tr style="font-weight:bold; background:#e5e7eb">
            <td colspan="${showEleve ? 3 : 2}" style="text-align:right">Total G√©n√©ral</td>
            <td style="text-align:right">${totalGeneral}</td>
        </tr>`;

        html += '</table>';
        $('#modalBody').html(html);

    });

});

// ==========================
// DOWNLOAD TABLE
// ==========================
function getModalTableData(){
    const table = $('#modalBody table')[0];
    if(!table) return null;

    const headers = [];
    $(table).find('th').each(function(){
        headers.push($(this).text().trim());
    });

    const rows = [];
    $(table).find('tr').not(':first').each(function(){
        const rowData = [];
        $(this).find('td').each(function(){
            rowData.push($(this).text().trim());
        });
        rows.push(rowData);
    });

    return { headers, rows };
}
// ==========================
// FERMER MODAL
// ==========================
$('#closeModal').on('click', function(){
    $('#statsModal').fadeOut(200);
});

// Fermer si clic en dehors du contenu
$('#statsModal').on('click', function(e){
    if(e.target === this){
        $(this).fadeOut(200);
    }
});

// G√©n√©rer nom de fichier selon stats
function getFileName(){
    const mapping = {
        'transactions': 'total_paiements',
        'paye': 'montant_paye',
        'attendu': 'total_attendu',
        'reste': 'reste_a_payer',
        'dette': 'eleves_en_dette',
        'rejet': 'paiements_rejetes'
    };
    return (mapping[currentStatsType] || 'dashboard') + '_' + new Date().toISOString().split('T')[0];
}

// Excel
$('#downloadExcel').on('click', function(){

    const annee = $('#anneeFilter').val();
    const classe = $('#classeFilter').val() || '';
    const eleve = $('#eleveFilter').val() || '';
    const trimestre = $('#trimestreFilter').val() || '';
    const variable = $('#variableFilter').val() || '';

    if(!annee){
        alert("Ann√©e obligatoire");
        return;
    }

    window.open(
        `/export-dashboard-excel/?type=${currentStatsType}&annee=${annee}&classe=${classe}&eleve=${eleve}&trimestre=${trimestre}&variable=${variable}`,
        "_blank"
    );

});


// PDF
$('#downloadPDF').on('click', function(){

    const table = $('#modalBody table');
    if(!table.length) return alert('Aucune donn√©e');

    const headers = [];
    table.find('th').each(function(){
        headers.push($(this).text().trim());
    });

    const rows = [];
    let totalGeneral = 0;

    table.find('tr').not(':first').each(function(){

        const row = [];

        $(this).find('td').each(function(){
            row.push($(this).text().trim());
        });

        if(row.length){
            const lastValue = parseFloat(row[row.length - 1]) || 0;
            totalGeneral += lastValue;
            rows.push(row);
        }

    });

    fetch('/export-dashboard-pdf/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()
        },
        body: JSON.stringify({
            title: $('#modalTitle').text(),
            headers: headers,
            rows: rows,
            total: totalGeneral,

            id_campus: $('#classeFilter option:selected').data('campus_id'),
            id_cycle: $('#classeFilter option:selected').data('cycle_id'),
            id_annee: $('#anneeFilter').val(),
            id_classe: $('#classeFilter').val(),
            id_eleve: $('#eleveFilter').val()
        })
    })
    .then(response => response.blob())
    .then(blob => {

        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');

        a.href = url;
        a.download = $('#modalTitle').text().replace(/\s+/g,'_') + '.pdf';

        document.body.appendChild(a);
        a.click();
        a.remove();

    });

});



});
</script>
