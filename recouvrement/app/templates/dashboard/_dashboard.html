<div class="dashboard">
    <h2 class="dashboard-title">ðŸ“Š Tableau de Bord Financier</h2>

    <!-- FILTRES -->
    <div class="filter-box">
        {% csrf_token %}
        <select id="anneeFilter">
            <option value="">AnnÃ©e scolaire</option>
            {% for a in annees %}
            <option value="{{a.id_annee}}">{{a}}</option>
            {% endfor %}
        </select>

        <select id="classeFilter"><option value="">Classe</option></select>
        <select id="trimestreFilter"><option value="">Trimestre</option></select>
        <select id="variableFilter"><option value="">Variable</option></select>
        <select id="eleveFilter"><option value="">Ã‰lÃ¨ve</option></select>

        <!-- <button id="applyFilter">Appliquer</button> -->
    </div>

    <!-- CARTES STATS -->
    <div class="dashboard-cards">
        <div class="card blue">
            <h4>Total Paiements</h4>
            <p id="totalPaiement">0</p>
        </div>
        <div class="card green">
            <h4>Montant PayÃ©</h4>
            <p id="montantPaye">0</p>
        </div>
        <div class="card purple">
            <h4>Total Attendu</h4>
            <p id="totalAttendu">0</p>
        </div>
        <div class="card orange">
            <h4>Reste Ã  Payer</h4>
            <p id="restePaye">0</p>
        </div>
        <div class="card red">
            <h4>Ã‰lÃ¨ves en Dette</h4>
            <p id="elevesDette">0</p>
        </div>
        <div class="card gray">
            <h4>Paiements RejetÃ©s</h4>
            <p id="totalRejete">0</p>
        </div>
    </div>

    <!-- GRAPHIQUES -->
    <!-- <div class="charts">
        <div class="chart-box">
            <canvas id="paiementChart"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="classeChart"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="evolutionChart"></canvas>
        </div>
    </div> -->
</div>

<style>
:root {
    --primary-color: #2563eb;
    --accent-color: #dc2626;
    --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}
.dashboard { margin-left:300px; padding:25px; max-width:calc(100% - 300px); font-family:sans-serif; }
.filter-box { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:25px; }
.filter-box select, .filter-box button { padding:8px 12px; border-radius:8px; border:1px solid #ddd; }
.filter-box button { background:var(--primary-color); color:white; cursor:pointer; font-weight:bold; }
.dashboard-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:20px; margin-bottom:30px; }
.card { padding:20px; border-radius:12px; color:white; box-shadow:var(--card-shadow); }
.card h4 { margin:0; font-size:14px; opacity:0.9; }
.card p { margin:10px 0 0; font-size:24px; font-weight:bold; }
.blue { background:linear-gradient(135deg,var(--primary-color),#1d4ed8); }
.green { background:linear-gradient(135deg,#16a34a,#15803d); }
.purple { background:linear-gradient(135deg,#7c3aed,#6d28d9); }
.red { background:linear-gradient(135deg,#dc2626,#b91c1c); }
.orange { background:linear-gradient(135deg,#f97316,#ea580c); }
.gray { background:linear-gradient(135deg,#6b7280,#4b5563); }
.charts { margin-top:30px; display:flex; flex-wrap:wrap; gap:20px; }
.chart-box { flex:1 1 450px; background:white; padding:15px; border-radius:12px; box-shadow:var(--card-shadow); min-height:300px; }
</style>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let paiementChart, classeChart, evolutionChart;
let selectedCampusId = null;
let selectedCycleId = null;

$(document).ready(function(){

    // =========================
    // ðŸ”µ ANNÃ‰E
    // =========================
    $('#anneeFilter').on('change', function(){
        const anneeId = $(this).val();
        loadClasses(anneeId);
    });

    // =========================
    // ðŸ”µ CLASSES
    // =========================
    function loadClasses(anneeId){
        $('#classeFilter, #trimestreFilter, #variableFilter, #eleveFilter').html('<option value="">Chargement...</option>');
        selectedCampusId = null;
        selectedCycleId = null;

        if(!anneeId){
            $('#classeFilter, #trimestreFilter, #variableFilter, #eleveFilter').html('<option value="">--</option>');
            loadDashboard(); // actualisation si rien n'est choisi
            return;
        }

        $.ajax({
            url: '/store_annee_session/',
            type: 'POST',
            data: {id_annee: anneeId, csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()},
            success: function(){
                fetch(`/get_classes_actives/${anneeId}/`)
                .then(res=>res.json())
                .then(data=>{
                    $('#classeFilter').html('<option value="">Classe</option>');
                    $('#trimestreFilter').html('<option value="">Trimestre</option>');
                    $('#variableFilter').html('<option value="">Variable</option>');
                    $('#eleveFilter').html('<option value="">Ã‰lÃ¨ve</option>');

                    if(data.success){
                        data.classes.forEach(c=>{
                            $('#classeFilter').append(
                                `<option value="${c.id_classe_active}" data-campus-id="${c.id_campus}" data-cycle-id="${c.id_cycle}">${c.campus_nom} - ${c.cycle_nom} - ${c.classe_nom}</option>`
                            );
                        });
                    }
                    loadDashboard(); // mise Ã  jour aprÃ¨s chargement des classes
                });
            }
        });
    }

    // =========================
    // ðŸ”µ CLASSE -> TRIMESTRES, VARIABLES, Ã‰LÃˆVES
    // =========================
    $('#classeFilter').on('change', function(){
        const opt = $(this).find(':selected');
        selectedCampusId = opt.data('campus-id');
        selectedCycleId = opt.data('cycle-id');

        const classeId = $(this).val();
        const anneeId = $('#anneeFilter').val();

        $('#trimestreFilter, #variableFilter, #eleveFilter').html('<option value="">Chargement...</option>');

        if(!classeId){ loadDashboard(); return; }

        // ðŸ”¹ Trimestres
        fetch(`/get_trimestres_by_classe_active/?id_classe_active=${classeId}&id_annee=${anneeId}&id_campus=${selectedCampusId}&id_cycle=${selectedCycleId}`)
        .then(res=>res.json())
        .then(data=>{
            $('#trimestreFilter').html('<option value="">Trimestre</option>');
            if(data.success){
                data.trimestres.forEach(t=>{
                    $('#trimestreFilter').append(`<option value="${t.id}">${t.nom} (${t.etat})</option>`);
                });
            }
            loadDashboard(); // mise Ã  jour aprÃ¨s chargement des trimestres
        });

        // ðŸ”¹ Ã‰lÃ¨ves
        fetch(`/get_pupils_registred_classe/?id_campus=${selectedCampusId}&id_cycle=${selectedCycleId}&id_classe_active=${classeId}&id_annee=${anneeId}`)
        .then(res=>res.json())
        .then(data=>{
            $('#eleveFilter').html('<option value="">Ã‰lÃ¨ve</option>');
            if(data.success){
                data.data.forEach(e=>{
                    $('#eleveFilter').append(`<option value="${e.id_eleve}">${e.nom_complet}</option>`);
                });
            }
            loadDashboard(); // mise Ã  jour aprÃ¨s chargement des Ã©lÃ¨ves
        });
    });

    // =========================
    // ðŸ”µ TRIMESTRE -> VARIABLES
    // =========================
    $('#trimestreFilter').on('change', function(){
        const trimestreId = $(this).val();
        const classeId = $('#classeFilter').val();
        const anneeId = $('#anneeFilter').val();

        $('#variableFilter').html('<option value="">Chargement...</option>');

        if(!trimestreId || !classeId){ loadDashboard(); return; }

        fetch(`/get-variables-by-trimestre/?id_trimestre=${trimestreId}&id_classe=${classeId}&id_annee=${anneeId}&id_campus=${selectedCampusId}&id_cycle=${selectedCycleId}`)
        .then(res=>res.json())
        .then(data=>{
            $('#variableFilter').html('<option value="">Variable</option>');
            if(data.success){
                data.variables.forEach(v=>{
                    $('#variableFilter').append(`<option value="${v.id_variable}">${v.nom_variable}</option>`);
                });
            }
            loadDashboard(); // mise Ã  jour aprÃ¨s chargement des variables
        });
    });

    // =========================
    // ðŸ”µ CHANGEMENT VARIABLE OU Ã‰LÃˆVE
    // =========================
    $('#variableFilter, #eleveFilter').on('change', function(){
        loadDashboard(); // mise Ã  jour immÃ©diate
    });

    // =========================
    // ðŸ”µ FONCTION LOAD DASHBOARD
    // =========================
    function loadDashboard(){
        const annee = $('#anneeFilter').val();
        const classe = $('#classeFilter').val();
        const eleve = $('#eleveFilter').val();
        const trimestre = $('#trimestreFilter').val();
        const variable = $('#variableFilter').val();

        if(!annee) return;

        fetch(`/dashboard-data/?annee=${annee}&classe=${classe}&eleve=${eleve}&trimestre=${trimestre}&variable=${variable}`)
        .then(res=>res.json())
        .then(data=>{
            if(!data.success){
                $('#totalPaiement,#montantPaye,#totalAttendu,#restePaye,#elevesDette,#totalRejete').text('0');
                return;
            }

            const stats = data.stats;
            $('#totalPaiement').text(stats.total_transactions || 0);
            $('#montantPaye').text(stats.total_paye || 0);
            $('#totalAttendu').text(stats.total_attendu || 0);
            $('#restePaye').text(stats.reste_a_payer || 0);
            $('#elevesDette').text(stats.eleves_en_dette || 0);
            $('#totalRejete').text(stats.total_rejete || 0);
        });
    }

});

</script>
